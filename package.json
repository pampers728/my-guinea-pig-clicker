import type { NextApiRequest, NextApiResponse } from 'next';
import { createClient } from '@supabase/supabase-js';
import { useState } from 'react';
import { useUser } from '../lib/auth';

const sb = createClient(
  process.env.SUPABASE_URL!,

  /* service‑role нужен для записи вне сессии пользователя */
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
);

const AD_URL = process.env.NEXT_PUBLIC_AD_LINK!;

export default function WatchAdButton() {
  const user = useUser();
  const [loading, setLoading] = useState(false);

  const handleClick = async () => {
    window.open(AD_URL, '_blank'); // открываем рекламу
    /*  
       как только сеть выдаст callback/редирект, вы должны получить
       от неё уникальный “adToken” – его можно передавать на
       клиент через query-параметр или ловить webhook.
    */
    setLoading(true);
    const resp = await fetch('/api/reward', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: user.id, adToken: 'полученный_токен' }),
    });
    const json = await resp.json();
    setLoading(false);
    if (json.ok) {
      alert('Вы получили морковки!');
    } else {
      alert('Ошибка: ' + json.error);
    }
  };

  return (
    <button onClick={handleClick} disabled={loading}>
      Смотреть рекламу
    </button>
  );
}

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') return res.status(405).end();
  const { userId, adToken } = req.body;
  if (!userId || !adToken) return res.status(400).json({ error: 'missing' });

  // 1. проверяем у сети
  const propeller = await fetch(`https://api.propellerads.com/v1/verify/${adToken}`, {
    headers: { Authorization: `Bearer ${process.env.PROP_API_KEY}` },
  });
  if (!propeller.ok) return res.status(400).json({ error: 'invalid token' });
  const info = await propeller.json();
  if (!info.success) return res.status(400).json({ error: 'not confirmed' });

  // 2. дневные лимиты (3 просмотра, 2000 морковок, 1000 энергии и т.п.)
  const startOfDay = new Date();
  startOfDay.setHours(0, 0, 0, 0);

  const { count } = await sb
    .from('rewards')
    .select('id', { count: 'exact' })
    .eq('user_id', userId)
    .gte('created_at', startOfDay.toISOString());

  if (count && count >= 3) {
    return res.status(429).json({ error: 'daily limit reached' });
  }

  // 3. начисляем (пример – 2000 морковок)
  const { error } = await sb
    .from('rewards')
    .insert({ user_id: userId, type: 'carrot', amount: 2000 });

  if (error) return res.status(500).json({ error: error.message });
  return res.status(200).json({ ok: true, added: 2000 });
}
